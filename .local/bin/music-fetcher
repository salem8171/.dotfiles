#!/usr/bin/env bash

PLAYLISTS_FILE="${XDG_DATA_HOME-:$HOME/.local/share}/$(basename "$0")/playlists.txt"
MUSIC_HOME="$HOME/Music"
export MUSIC_HOME

error() { echo -e "$@" >&2 && exit 1; }

assert-exist() {
  for exe; do
    [ ! -x "$(command -v "$exe")" ] && error "$exe not found in PATH";
  done
  return 0
}

download-playlist() {
  YOUTUBE_DL_CMD=(
    youtube-dl
    "-ciw"
    "--yes-playlist"
    "--extract-audio"
    "--audio-format" "mp3"
    "--download-archive" "ytdl_archive.txt"
  )

  playlist_name="$(awk '{ print $1 }' <<< "$1")"
  playlist_url="$(awk '{ print $2 }' <<< "$1")"
  mkdir -p "$MUSIC_HOME/$playlist_name"
  (
    cd "$MUSIC_HOME/$playlist_name" ||
      error "Could not find $MUSIC_HOME/$playlist_name"
    "${YOUTUBE_DL_CMD[@]}" "$playlist_url"
  )
}

export -f download-playlist

assert-exist youtube-dl

[ -f "$PLAYLISTS_FILE" ] || {
  mkdir -p "$(dirname "$PLAYLISTS_FILE")"
  touch "$PLAYLISTS_FILE"
}

sed '/^\s*$/d; /^#/d' "$PLAYLISTS_FILE" |
  parallel --jobs 6 --line-buffer download-playlist "{}"
